version: '2.4'

networks:

    connected:
        name: seedbox_connected
        driver: bridge
        ipam:
            driver: default
            config: # http://www.subnet-calculator.com/subnet.php?net_class=B
            - subnet: 172.1.0.0/25 # 172.1.0.1 - 172.1.0.126
              gateway: 172.1.0.126
              ip_range: 172.1.0.0/26 # 172.1.0.1 - 172.1.0.62

    hidden:
        name: seedbox_hidden
        internal: true

volumes:
    elasticsearch_data: {}
    grafana_data: {}
    influx_data: {}
    minecraft_data: {}
    mongo_data: {}
    # mosquitto_data: {}
    prometheus_data: {}

services:

    elasticsearch: # Json database
        container_name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:7.3.2
        restart: ${RESTART_MODE}
        environment:
          discovery.type: single-node
          ES_JAVA_OPTS: "-Xmx512m -Xms512m"
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    curator: # Elasticsearch indices janitor
        container_name: curator
        image: praseodym/elasticsearch-curator
        restart: ${RESTART_MODE}
        command:
            - '--config'
            - 'config.yml'
            - 'action.yml'
        networks:
            - hidden
        depends_on:
            - elasticsearch
        volumes:
            - ./config/curator/config.yml:/curator/config.yml
            - ./config/curator/action.yml:/curator/action.yml
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    kibana: # Elasticsearch data UI
        container_name: kibana
        image: docker.elastic.co/kibana/kibana:7.3.2
        restart: ${RESTART_MODE}
        environment:
            SERVER_NAME: kibana
            LOGGING_QUIET: 'true'
        networks:
            - connected
            - hidden
        depends_on:
            - elasticsearch
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:kibana.${DOMAIN}"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=5601"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    filebeat: # Logs watcher
        container_name: filebeat
        image: docker.elastic.co/beats/filebeat:7.3.2
        restart: ${RESTART_MODE}
        command: filebeat -e -strict.perms=false
        user: root
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/lib/docker:/var/lib/docker:ro
            - ./config/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
        networks:
            - hidden
        depends_on:
            - elasticsearch
            - kibana
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    samba: # SMB server
        container_name: samba
        image: dperson/samba
        command: '-s "shared;/mount;yes;no;yes;all;none"'
        restart: ${RESTART_MODE}
        ports:
            - "139:139"
            - "445:445"
        volumes:
            - ./download/complete:/mount/downloads
            - ./shared:/mount/shared
            - /media/nuc/WD2To:/mount/media
        networks:
            - connected
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    sftp: # Sftp server
        container_name: sftp
        image: atmoz/sftp
        command: ${SFTP_COMMAND}
        restart: ${RESTART_MODE}
        ports:
            - "32768:22"
        volumes:
            - ./download/complete:/home/shokohsc/upload/downloads
            - ./shared:/home/shokohsc/upload/shared
            - /media/nuc/WD2To:/home/shokohsc/upload/media
        networks:
            - connected
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    duckdns: # Dynamic IP <-> Domain
        container_name: duckdns
        image: linuxserver/duckdns
        restart: ${RESTART_MODE}
        environment:
            SUBDOMAINS: ${DUCKDNS_SUBDOMAINS}
            TOKEN: ${DUCKDNS_TOKEN}
            TZ: ${TIMEZONE}
        networks:
            - connected
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    openvpn: # Internal vpn
        container_name: openvpn
        image: kylemanna/openvpn
        tty: true
        cap_add:
            - net_admin
        restart: ${RESTART_MODE}
        expose:
            - "5555"
        ports:
            - "32767:1194/udp"
        logging:
            driver: none
        volumes:
            - ./config/openvpn:/etc/openvpn
        networks:
            - connected
        labels:
            - "traefik.enable=false"

    gateway: # Torrenting vpn
        container_name: gateway
        image: dperson/openvpn-client
        cap_add:
            - net_admin
        restart: ${RESTART_MODE}
        command: "-r 192.168.1.0/24 -p 9091"
        # command: "-r 192.168.1.0/24 -p 9091 -v server;username;password;port"
        ports:
            - "32766:51413/tcp"
            - "32766:51413/udp"
        volumes:
            - ./vpn_conf.ovpn:/vpn/vpn_conf.ovpn
            # - ./vpn_conf.ovpn:/vpn/vpn-ca.crt
        environment:
            TZ: ${TIMEZONE}
        devices:
            - "/dev/net/tun:/dev/net/tun"
        networks:
            connected:
                ipv4_address: 172.1.0.63
        dns: 8.8.8.8
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:transmission.${DOMAIN}"
            - "traefik.port=9091"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    gateway-sidekick:
        container_name: gateway-sidekick
        image: shokohsc/gateway-sidekick
        restart: ${RESTART_MODE}
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    php-fpm-gateway-sidekick:
        container_name: php-fpm-gateway-sidekick
        image: shokohsc/alpine-php-fpm
        restart: ${RESTART_MODE}
        command: php index.php
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
            HOST_TARGET: "https://transmission.${DOMAIN}"
            VPN_FILE_PATH: '/var/www/symfony/vpn_conf.ovpn'
            WAIT_GATEWAY_TIME: 300
        volumes:
            - ./vpn_conf.ovpn:/var/www/symfony/vpn_conf.ovpn
            - /var/run/docker.sock:/var/run/docker.sock
        volumes_from:
            - gateway-sidekick
        networks:
            - connected
        depends_on:
            - gateway
            - gateway-sidekick
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    traefik: # Reverse proxy
        container_name: traefik
        image: traefik:1.7.16-alpine
        restart: ${RESTART_MODE}
        command: --api --docker --metrics --metrics.prometheus
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./config/traefik/certs:/etc/traefik/certs
            - ./config/traefik/traefik.toml:/etc/traefik/traefik.toml
        networks:
            - connected
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:traefik.${DOMAIN}"
            - "traefik.port=8080"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    portainer: # Docker management
        container_name: portainer
        image: portainer/portainer
        restart: ${RESTART_MODE}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        networks:
            - connected
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:portainer.${DOMAIN}"
            - "traefik.port=9000"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    transmission: # Torrent client
        container_name: transmission
        image: linuxserver/transmission
        restart: ${RESTART_MODE}
        volumes:
            - ./config/transmission:/config
            - ./download:/downloads
            - ./shared/transmission:/watch
        network_mode: "service:gateway"
        depends_on:
            - gateway
        labels:
            - "autoheal=true"
        healthcheck:
            test: ["CMD", "curl", "-IkLX", "GET", "http://ifconfig.co"]
            interval: 1m30s
            timeout: 10s
            retries: 5
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    autoheal: # Service looking for container to restart
        container_name: autoheal
        image: willfarrell/autoheal
        restart: ${RESTART_MODE}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        networks:
            - connected
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    commander: # Web ui server admin
        container_name: commander
        image: coderaiser/cloudcmd
        restart: ${RESTART_MODE}
        volumes:
            - /:/mnt/fs
            - ./download/complete:/root/downloads
            - ./shared:/root/shared
            - /media/nuc/WD2To:/root/media
        networks:
            - connected
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:commander.${DOMAIN}"
            - "traefik.port=8000"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    plex: # Media server
        container_name: plex
        image: linuxserver/plex
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            VERSION: latest
            PLEX_CLAIM: ${PLEX_CLAIM}
            ADVERTISE_IP: ${PLEX_ROOT_URL}
            TZ: ${TIMEZONE}
        ports:
            - "32400:32400/tcp"
            - "3005:3005/tcp"
            - "8324:8324/tcp"
            - "32469:32469/tcp"
            - "1900:1900/udp"
            - "32410:32410/udp"
            - "32412:32412/udp"
            - "32413:32413/udp"
            - "32414:32414/udp"
            - "32400:32400/udp"
            - "32469:32469/udp"
            - "5353:5353/tcp"
        devices:
            - "/dev/dri:/dev/dri"
        volumes:
            - ./config/plex:/config
            - ./work/plex:/transcode
            - /media/nuc/WD2To:/data/media
            - ./download/complete:/data/downloads
        networks:
            - connected
        hostname: "plex"
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:plex.${DOMAIN}"
            - "traefik.port=32400"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    grafana: # Monitoring tool connected server
        container_name: grafana
        image: grafana/grafana:5.2.4
        restart: ${RESTART_MODE}
        environment:
            GF_SECURITY_ADMIN_PASSWORD: ${GLOBAL_PASSWORD}
            GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL}
            GF_SMTP_ENABLED: ${GF_SMTP_ENABLED}
            GF_SMTP_HOST: ${GF_SMTP_HOST}
            GF_SMTP_USER: ${GF_SMTP_USER}
            GF_SMTP_PASSWORD: ${GF_SMTP_PASSWORD}
            GF_SMTP_FROM_ADDRESS: ${GF_SMTP_FROM_ADDRESS}
            GF_SMTP_FROM_NAME: ${GF_SMTP_FROM_NAME}
            GF_INSTALL_PLUGINS: grafana-piechart-panel
            GF_LOG_LEVEL: warn
        volumes:
            - grafana_data:/var/lib/grafana
            - ./config/grafana/setup.sh:/setup.sh
        entrypoint: /setup.sh
        networks:
            - connected
            - hidden
        depends_on:
            - prometheus
            - pushgateway
            - nodeexporter
            - cadvisor
            # - influxdb
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:grafana.${DOMAIN}"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=3000"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    prometheus: # Database, grafana requirement
        image: prom/prometheus:v2.4.3
        container_name: prometheus
        restart: ${RESTART_MODE}
        volumes:
            - ./config/prometheus/:/etc/prometheus/
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention=24h'
            - '--web.enable-lifecycle'
        networks:
            - connected
            - hidden
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    alertmanager: # Grafana requirement
        image: prom/alertmanager:v0.15.2
        container_name: alertmanager
        volumes:
            - ./config/alertmanager/:/etc/alertmanager/
        command:
            - '--config.file=/etc/alertmanager/config.yml'
            - '--storage.path=/alertmanager'
        restart: ${RESTART_MODE}
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    nodeexporter: # Grafana requirement
        image: prom/node-exporter:v0.16.0
        container_name: nodeexporter
        restart: ${RESTART_MODE}
        user: root
        privileged: true
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
        command:
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    cadvisor: # Grafana requirement
        image: google/cadvisor:v0.31.0
        container_name: cadvisor
        restart: ${RESTART_MODE}
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:rw
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
            - /cgroup:/cgroup:ro #doesn't work on MacOS only for Linux
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    pushgateway: # Grafana requirement
        image: prom/pushgateway
        container_name: pushgateway
        restart: ${RESTART_MODE}
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    heimdall: # Heimdall
        image: linuxserver/heimdall
        container_name: heimdall
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        volumes:
            - ./config/heimdall:/config
        networks:
            - connected
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:heimdall.${DOMAIN}"
            - "traefik.port=80"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    monitor: # Openvpn monitor
        image: ruimarinho/openvpn-monitor
        container_name: monitor
        restart: ${RESTART_MODE}
        environment:
            OPENVPNMONITOR_DEFAULT_MAPS: "True"
            OPENVPNMONITOR_DEFAULT_DATETIMEFORMAT: ${OPENVPNMONITOR_DEFAULT_DATETIMEFORMAT}
            OPENVPNMONITOR_DEFAULT_LATITUDE: ${OPENVPNMONITOR_DEFAULT_LATITUDE}
            OPENVPNMONITOR_DEFAULT_LONGITUDE: ${OPENVPNMONITOR_DEFAULT_LONGITUDE}
            OPENVPNMONITOR_DEFAULT_SITE: ${OPENVPNMONITOR_DEFAULT_SITE}
            OPENVPNMONITOR_SITES_0_HOST: ${OPENVPNMONITOR_SITES_0_HOST}
            OPENVPNMONITOR_SITES_0_NAME: ${OPENVPNMONITOR_SITES_0_NAME}
            OPENVPNMONITOR_SITES_0_PORT: ${OPENVPNMONITOR_SITES_0_PORT}
        networks:
            - connected
        depends_on:
            - openvpn
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:monitor.${DOMAIN}"
            - "traefik.port=80"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    comic-reader:
        container_name: comic-reader
        image: shokohsc/server-comic-reader
        restart: ${RESTART_MODE}
        tty: true
        volumes:
            - /var/www/symfony
            - ./shared/gazee:/var/www/symfony/public/files/weekly
            - /media/nuc/WD2To/comics:/var/www/symfony/public/files/all
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    php-fpm-comic:
        container_name: php-fpm-comic
        image: shokohsc/alpine-php-fpm
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        volumes_from:
            - comic-reader
        networks:
            - hidden
        depends_on:
            - comic-reader
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    nginx-comic:
        container_name: nginx-comic
        image: shokohsc/alpine-nginx
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        volumes_from:
            - comic-reader
        networks:
            - hidden
            - connected
        links:
            - "php-fpm-comic:php-fpm"
        depends_on:
            - php-fpm-comic
            - comic-reader
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:comics.${DOMAIN}"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=80"
        logging:
            options:
                max-size: "50k"
                max-file: "2"


    wol-web:
        container_name: wol-web
        image: shokohsc/server-wol
        restart: ${RESTART_MODE}
        tty: true
        volumes:
            - /var/www/symfony
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    php-fpm-wol:
        container_name: php-fpm-wol
        image: shokohsc/alpine-php-fpm
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        volumes_from:
            - wol-web
        networks:
            - connected
        depends_on:
            - wol-web
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    nginx-wol:
        container_name: nginx-wol
        image: shokohsc/alpine-nginx
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        volumes_from:
            - wol-web
        networks:
            - connected
        links:
            - "php-fpm-wol:php-fpm"
        depends_on:
            - php-fpm-wol
            - wol-web
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:wol.${DOMAIN}"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=80"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    paint-web:
        container_name: paint-web
        image: shokohsc/mini-paint
        restart: ${RESTART_MODE}
        environment:
            PGID: ${PGID}
            PUID: ${PUID}
            TZ: ${TIMEZONE}
        networks:
            - connected
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:paint.${DOMAIN}"
            - "traefik.port=80"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    telegraf: # Telegraf
        container_name: telegraf
        image: telegraf
        restart: ${RESTART_MODE}
        networks:
            - connected
            - hidden
        volumes:
            - ./config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf
        depends_on:
            - influxdb
            # - mosquitto
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"
    #
    influxdb: # InfluxDB
        container_name: influxdb
        image: influxdb
        restart: ${RESTART_MODE}
        environment:
            INFLUXDB_DB: miflora
            INFLUXDB_USER: miflora
            INFLUXDB_USER_PASSWORD: ${INFLUXDB_USER_PASSWORD}
        networks:
            - hidden
        volumes:
            - influx_data:/var/lib/influxdb
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    chronograf: # InfluxDB Admin UI
        image: chronograf
        container_name: chronograf
        restart: ${RESTART_MODE}
        command: --influxdb-url=http://influxdb:8086
        networks:
            - connected
            - hidden
        depends_on:
            - influxdb
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:chronograf.${DOMAIN}"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=8888"
        logging:
            options:
                max-size: "50k"
                max-file: "2"
    #
    # mosquitto: # Mosquitto mqtt broker
    #     container_name: mosquitto
    #     image: eclipse-mosquitto
    #     restart: ${RESTART_MODE}
    #     ports:
    #         - "1883:1883/tcp"
    #     networks:
    #         - connected
    #     volumes:
    #         - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    #         - mosquitto_data:/mosquitto/data
    #     labels:
    #         - "traefik.enable=false"
    #     logging:
    #         options:
    #             max-size: "50k"
    #             max-file: "2"

    # miflora-daemon: # Miflora daemon
    #     container_name: miflora-daemon
    #     build:
    #         context: miflora-mqtt-daemon
    #     cap_add:
    #         - net_admin
    #         - sys_admin
    #     restart: ${RESTART_MODE}
    #     volumes:
    #         - ./config/miflora/config.ini:/app/config.ini
    #     network_mode: host
    #     depends_on:
    #         - mosquitto
    #     logging:
    #         options:
    #             max-size: "50k"
    #             max-file: "2"
    #
    # mqtt-forwarder:
    #     container_name: mqtt-forwarder
    #     build:
    #         context: mqtt-forwarder
    #     restart: ${RESTART_MODE}
    #     environment:
    #         INFLUXDB_HOST: influxdb
    #         INFLUXDB_DB: miflora
    #         INFLUXDB_USER: miflora
    #         INFLUXDB_PASSWORD: ${INFLUXDB_USER_PASSWORD}
    #         MQTT_HOST: mosquitto
    #         MQTT_TOPIC: ${MQTT_TOPIC}
    #     networks:
    #         - connected
    #         - hidden
    #     depends_on:
    #         - influxdb
    #         - mosquitto
    #     labels:
    #         - "traefik.enable=false"
    #     logging:
    #         options:
    #             max-size: "50k"
    #             max-file: "2"

    minecraft:
        container_name: minecraft
        image: itzg/minecraft-server
        restart: ${RESTART_MODE}
        environment:
            EULA: 'TRUE'
        ports:
            - "25565:25565/tcp"
        volumes:
            - minecraft_data:/data
            - ./config/minecraft/server.properties:/data/server.properties
        networks:
            - connected
        labels:
            - "traefik.enable=false"
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    mongo: # Wekan requirement
        image: mongo
        container_name: mongo
        restart: ${RESTART_MODE}
        volumes:
            - mongo_data:/data/db
        networks:
            - hidden
        logging:
            options:
                max-size: "50k"
                max-file: "2"

    wekan: # Wekan
        image: wekanteam/wekan
        container_name: wekan
        restart: ${RESTART_MODE}
        environment:
            ROOT_URL: ${WK_ROOT_URL}
            MONGO_URL: ${MONGO_URL}/wekan
        networks:
            - connected
            - hidden
        depends_on:
            - mongo
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:wekan.shokohsc"
            - "traefik.docker.network=${EXPOSED_NETWORK}"
            - "traefik.port=8080"
